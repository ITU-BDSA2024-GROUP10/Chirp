@using Chirp.Core
@using Chirp.Core.DTO
@inject IAuthorService service
@{
    var targetPage = ViewBag.TargetPage as string ?? "";
    IEnumerable<CheepDTO> cheeps = ViewBag.Cheeps;
    List<AuthorDTO> Follows = [];
    if (User.Identity!.IsAuthenticated)
    {
        Follows = service.GetFollows(User.Identity!.Name!);
    }
}

<ul id="messagelist" class="cheeps">
    @foreach (var cheep in cheeps)
    {
        <li>
            <p>
                <strong>
                    <a href="/@cheep.Author">@cheep.Author</a>
                    @if (User.Identity!.IsAuthenticated && User.Identity!.Name != cheep.Author)
                    {    
                        if (Follows.Any(a => a.Name == cheep.Author))
                        {
                            <form method="post" asp-page="/follow">
                                <input type="hidden" name="followName" value="@cheep.Author" />
                                <input type="hidden" name="shouldFollow" value="false" />
                                <input type="hidden" name="returnUrl" value="@targetPage" />
                                <button type="submit" value="Share">unfollow</button>
                            </form>
                        }
                        else
                        {
                            <form method="post" asp-page="/follow">
                                <input type="hidden" name="followName" value="@cheep.Author" />
                                <input type="hidden" name="shouldFollow" value="true" />
                                <input type="hidden" name="returnUrl" value="@targetPage" />
                                <button type="submit" value="Share">follow</button>
                            </form>
                        }
                    }
                </strong>
                @cheep.Message
                <small>&mdash; @DateTimeOffset.FromUnixTimeSeconds(cheep.UnixTimestamp).DateTime.ToString("dd/MM/yy H:mm:ss")</small>
            </p>
        </li>
    }
</ul>